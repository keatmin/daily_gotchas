<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.5">
<link rel="alternate" type="application/rss+xml" href="/daily_gotchas/gotchas/rss.xml" title="Daily Gotchas Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/daily_gotchas/gotchas/atom.xml" title="Daily Gotchas Blog Atom Feed"><title data-react-helmet="true">Daily Gotchas | Daily Gotchas</title><meta data-react-helmet="true" property="og:title" content="Daily Gotchas | Daily Gotchas"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="description" content="The daily gotchas that got us"><meta data-react-helmet="true" property="og:description" content="The daily gotchas that got us"><meta data-react-helmet="true" property="og:url" content="https://keatmin.github.io/daily_gotchas/gotchas"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="blog_posts_list"><link data-react-helmet="true" rel="shortcut icon" href="/daily_gotchas/img/logo.png"><link data-react-helmet="true" rel="canonical" href="https://keatmin.github.io/daily_gotchas/gotchas"><link data-react-helmet="true" rel="alternate" href="https://keatmin.github.io/daily_gotchas/gotchas" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://keatmin.github.io/daily_gotchas/gotchas" hreflang="x-default"><link rel="stylesheet" href="/daily_gotchas/assets/css/styles.d57fd202.css">
<link rel="preload" href="/daily_gotchas/assets/js/runtime~main.dd476a90.js" as="script">
<link rel="preload" href="/daily_gotchas/assets/js/main.0dc225b4.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/daily_gotchas/"></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/daily_gotchas/gotchas">gotchas</a><a class="navbar__item navbar__link" href="/daily_gotchas/knowledge">knowledge</a></div><div class="navbar__items navbar__items--right"><div class="react-toggle toggle_3Zt9 react-toggle--checked react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">üåú</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">üåû</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" checked="" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">Recent posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/daily_gotchas/gotchas/aiohttp-client-settings">AIOHttp Client Settings</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/daily_gotchas/gotchas/efficient-sql-filter">Efficient SQL filtering</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/daily_gotchas/gotchas/aws-iam-assume-role">Assuming role in AWS</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/daily_gotchas/gotchas/python-mypy-config">mypy Configurations</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/daily_gotchas/gotchas/docker-security">Docker Security</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/daily_gotchas/gotchas/aiohttp-client-settings">AIOHttp Client Settings</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-08-24T00:00:00.000Z" itemprop="datePublished">August 24, 2021</time> ¬∑ One min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://github.com/jianshen92" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://github.com/jianshen92.png" alt="jianshen"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/jianshen92" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">jianshen</span></a></div><small class="avatar__subtitle" itemprop="description">MLE at Shopback</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="aiohttp-client-settings"></a>Aiohttp Client settings<a class="hash-link" href="#aiohttp-client-settings" title="Direct link to heading">#</a></h2><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> aiohttp</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">class</span><span class="token plain"> </span><span class="token class-name">HttpClient</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    session</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> aiohttp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ClientSession </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">start</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">session </span><span class="token operator">=</span><span class="token plain"> aiohttp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ClientSession</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            connector</span><span class="token operator">=</span><span class="token plain">aiohttp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">TCPConnector</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">force_close</span><span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            timeout</span><span class="token operator">=</span><span class="token plain">aiohttp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ClientTimeout</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">total</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">async</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">stop</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">session</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">close</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">session </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">__call__</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token plain"> aiohttp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ClientSession</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">assert</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">session </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">is</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">not</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">session</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ol><li><p>Having a singleton like <code>HttpClient</code>, can be used in conjucntion with your web server that makes 3rd party API call. Only initialize the session once at the beginning of the startup</p></li><li><p><code>aiohttp.TCPConnector(force_close=True)</code> will fix the bug where sometimes connection pool is not released after request.</p></li><li><p><code>aiohttp.ClientTimeout(total=5)</code> sets timeout for your requests, in seconds. Response that takes longer that 5 seconds will throw a TimeoutError</p></li></ol></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/daily_gotchas/gotchas/tags/python">python</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/daily_gotchas/gotchas/tags/aiohttp">aiohttp</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/daily_gotchas/gotchas/efficient-sql-filter">Efficient SQL filtering</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-08-24T00:00:00.000Z" itemprop="datePublished">August 24, 2021</time> ¬∑ One min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://github.com/jianshen92" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://github.com/jianshen92.png" alt="jianshen"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/jianshen92" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">jianshen</span></a></div><small class="avatar__subtitle" itemprop="description">MLE at Shopback</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Putting this here because I&#x27;m surprised even sometimes the experienced data scientist does not know about this.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="q-given-table-a-and-b-that-relates-each-other-by-user_id-find-rows-on-a-where-user_id-is-not-present-on-b"></a>Q: Given table A and B that relates each other by user_id, find rows on A where user_id is not present on B.<a class="hash-link" href="#q-given-table-a-and-b-that-relates-each-other-by-user_id-find-rows-on-a-where-user_id-is-not-present-on-b" title="Direct link to heading">#</a></h3><p>Typically, people like to do</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><pre tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token operator">*</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> A</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">WHERE</span><span class="token plain"> A</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">user_id </span><span class="token operator">NOT</span><span class="token plain"> </span><span class="token operator">IN</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">DISTINCT</span><span class="token plain"> user_id </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> B</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>What I prefer,</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><pre tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token operator">*</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> A</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">LEFT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">JOIN</span><span class="token plain"> B</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">ON</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  A</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">user_id </span><span class="token operator">=</span><span class="token plain"> B</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">user_id</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">WHERE</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  B</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">user_id </span><span class="token operator">IS</span><span class="token plain"> </span><span class="token boolean">NULL</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The initial expectation was, using <code>IN</code> where the Array object is huge can be much slower than <code>JOIN</code>. However, modern DWH such as Redshift and BigQuery
seems to have smart query planner that are able to recognize this query pattern. Query cost for both method on these DW are the same.</p><p>However, can&#x27;t say the same for row-based RDBMS.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/daily_gotchas/gotchas/tags/database">database</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/daily_gotchas/gotchas/tags/sql">sql</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/daily_gotchas/gotchas/aws-iam-assume-role">Assuming role in AWS</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-08-10T00:00:00.000Z" itemprop="datePublished">August 10, 2021</time> ¬∑ 2 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://github.com/keatmin" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://github.com/keatmin.png" alt="keatmin"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/keatmin" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">keatmin</span></a></div><small class="avatar__subtitle" itemprop="description">Data nerd</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Not a new gotcha, but a reminder on how to assume role:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;Version&quot;: &quot;2012-10-17&quot;,</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;Statement&quot;: [</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &quot;Sid&quot;: &quot;VisualEditor0&quot;,</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &quot;Effect&quot;: &quot;Allow&quot;,</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &quot;Action&quot;: &quot;sts:AssumeRole&quot;,</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &quot;Resource&quot;: [</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                &quot;arn:aws:iam::&lt;account_no&gt;:role/Role&quot;,</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                &quot;arn:aws:iam::&lt;account_no&gt;:role/Role2&quot;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            ]</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ]</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>With above inline policy for a user, the user can:
assume <code>Role</code> or <code>Role2</code> on their local with aws cli using</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">aws sts assume-role</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    --role-arn </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;arn:of:role&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    --role-session-name </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;name&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    --profile </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;profile_name_of_user&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="admonition admonition-caution alert alert--warning"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</h5></div><div class="admonition-content"><p><strong>‚ùó Never use default profile for your aws</strong> Instead use <code>aws configure</code> to configure a profile that&#x27;s not default</p></div></div><p>To only allow conditions on who and how to assume role, add</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly json"><pre tabindex="0" class="prism-code language-json codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token property">&quot;Condition&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">&quot;ForAllValues:StringEquals&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token property">&quot;aws:username&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;keat&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>To allow tag-based policy:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly json"><pre tabindex="0" class="prism-code language-json codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">&quot;Version&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;2012-10-17&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">&quot;Statement&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">&quot;Sid&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;VisualEditor0&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">&quot;Effect&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Allow&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">&quot;Action&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;sts:AssumeRole&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">&quot;Resource&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;arn:aws:iam::&lt;account_no&gt;:role/Role-*&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token property">&quot;Condition&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token property">&quot;StringEquals&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token property">&quot;aws:ResourceTag/Team&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;${aws:PrincipalTag/Team}&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Assuming there are multiple roles, with <code>Role-</code> prefix, each with its respective resource tag <code>Team</code> that is referring to a specific team.</p><p>The above condition ensure that the resource tag <code>Team</code> for <code>Role-*</code> matches the resource tag <code>Team</code> for <code>Principal</code> before allowing the access to it.</p><p>The above example is not only limited to assume role, allowing <code>Action</code>s to tagged resources can be done similarly based on the principal tag of the user.</p><p>For reference on what conditions are available, refer to <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_variables.html#policy-vars-wheretouse" target="_blank" rel="noopener noreferrer">docs</a></p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/daily_gotchas/gotchas/tags/aws">aws</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/daily_gotchas/gotchas/tags/iam">iam</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/daily_gotchas/gotchas/python-mypy-config">mypy Configurations</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-08-01T00:00:00.000Z" itemprop="datePublished">August 1, 2021</time> ¬∑ One min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://github.com/keatmin" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://github.com/keatmin.png" alt="keatmin"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/keatmin" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">keatmin</span></a></div><small class="avatar__subtitle" itemprop="description">Data nerd</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>mypy usually doesn&#x27;t check types inside the function scope but generally in module scope, hence:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># module scope that will make mypy scream</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">x </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">5</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">print</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">x </span><span class="token operator">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;hello&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Function scope that will pass mypy checks if there is no type hints</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">foo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    x </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">5</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">print</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">x </span><span class="token operator">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;hello&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">foo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">x</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">int</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    x </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">5</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">print</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">x </span><span class="token operator">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;hello&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ul><li><p>To allow checking inside function, adding <code>check_untyped_defs</code> will make mypy check the function scope that doesn&#x27;t have type hints.</p></li><li><p>This is useful because if we are migrating a codebase to start using type hints, then this will start with checking all the types within a function and we can start solving from there.</p></li><li><p>One other feature to add after <code>check_untyped_defs</code> is to add <code>disallow_untyped_defs</code> so that mypy will make sure that there&#x27;s no functions with no type hints</p></li></ul><div class="codeBlockContainer_K1bP"><div style="color:#F8F8F2;background-color:#282A36" class="codeBlockTitle_eoMF">pyproject.toml</div><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">tool.mypy</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">check_untyped_defs = true</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">disallow_untyped_defs = true</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Other notable config:
<code>disallow_incomplete_defs</code></p><p>Source:</p><ol><li><a href="https://www.youtube.com/watch?v=Rk-Y71P_9KE" target="_blank" rel="noopener noreferrer">Asottile&#x27;s</a></li><li><a href="https://mypy.readthedocs.io/en/stable/config_file.html" target="_blank" rel="noopener noreferrer">mypy</a></li></ol></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/daily_gotchas/gotchas/tags/python">python</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/daily_gotchas/gotchas/tags/mypy">mypy</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/daily_gotchas/gotchas/docker-security">Docker Security</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-07-24T00:00:00.000Z" itemprop="datePublished">July 24, 2021</time> ¬∑ One min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://github.com/keatmin" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://github.com/keatmin.png" alt="keatmin"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/keatmin" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">keatmin</span></a></div><small class="avatar__subtitle" itemprop="description">Data nerd</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><ol><li><code>Run apt-get update &amp;&amp; apt-get -y upgrade</code> ensure security in docker image is up to date. Ensure that CI/CD rebuilds the image regularly to ensure that the latest security patch is updated in docker image</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">docker build --pull --no-cache</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ol start="2"><li><code>apt-get install</code> commands should be paired with a <code>rm -rf /var/lib/apt/lists/*</code> in the same layer and also used with <code>-y --no-install-recommends</code></li></ol><p>Source:</p><ul><li><a href="https://pythonspeed.com/articles/docker-cache-insecure-images/" target="_blank" rel="noopener noreferrer">blog</a></li><li><a href="https://talkpython.fm/episodes/show/323/best-practices-for-docker-in-production" target="_blank" rel="noopener noreferrer">podcast with author</a></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/daily_gotchas/gotchas/tags/docker">docker</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/daily_gotchas/gotchas/tags/dev">dev</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/daily_gotchas/gotchas/tags/security">security</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/daily_gotchas/gotchas/git-merge-pr">Git Merge PR</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-07-09T00:00:00.000Z" itemprop="datePublished">July 9, 2021</time> ¬∑ One min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://github.com/jianshen92" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://github.com/jianshen92.png" alt="jianshen"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/jianshen92" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">jianshen</span></a></div><small class="avatar__subtitle" itemprop="description">MLE at Shopback</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Typically when we merge Pull Request from short lived branches (feature branch) to long lived branches,
the best practice is to squash and merge to keep the main lineage clean.</p><p>However, when we want to conduct PR merging between two long lived branch (e.g, : main -&gt; staging, staging -&gt; prod ),
it is better to do a MERGE instead, else, every time a PR is made, the PR diff will reflect all changes since the beginning of time where both branch diverge.
Reason <a href="https://docs.github.com/en/github/collaborating-with-pull-requests/incorporating-changes-from-a-pull-request/about-pull-request-merges#squashing-and-merging-a-long-running-branch" target="_blank" rel="noopener noreferrer">here</a>.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/daily_gotchas/gotchas/tags/dev">dev</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/daily_gotchas/gotchas/tags/git">git</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/daily_gotchas/gotchas/python-pytest-mock">Pytest Mock</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-07-08T00:00:00.000Z" itemprop="datePublished">July 8, 2021</time> ¬∑ One min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://github.com/keatmin" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://github.com/keatmin.png" alt="keatmin"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/keatmin" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">keatmin</span></a></div><small class="avatar__subtitle" itemprop="description">Data nerd</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="unit-testing-on-a-function-whether-an-exception-is-properly-raised"></a>Unit testing on a function whether an exception is properly raised<a class="hash-link" href="#unit-testing-on-a-function-whether-an-exception-is-properly-raised" title="Direct link to heading">#</a></h3><ul><li>Using <code>pytest.raises</code></li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> pytest</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">test_func_division_error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">with</span><span class="token plain"> pytest</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">raises</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ZeroDivisionError</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token number">9</span><span class="token operator">/</span><span class="token number">0</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ul><li>To allow an exception to be raised, the decorator <code>@pytest.mark.xfail(raise=ZeroDivisionError)</code> can be used. However note that it is only allowing <code>ZeroDivisionError</code> to be raised and not testing whether the func will raise an Exception.</li></ul><p>Additional Tips from @jianshen92:
If mocking a function and expect the function to throw error:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">with</span><span class="token plain"> patch</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;function_to_mock&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">as</span><span class="token plain"> f</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  f</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">side_effect </span><span class="token operator">=</span><span class="token plain"> ZeroDivisionError</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Useful when function has a third party call</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/daily_gotchas/gotchas/tags/python">python</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/daily_gotchas/gotchas/tags/pytest">pytest</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/daily_gotchas/gotchas/python-lru-cache">LRU cache</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-07-01T00:00:00.000Z" itemprop="datePublished">July 1, 2021</time> ¬∑ One min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://github.com/keatmin" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://github.com/keatmin.png" alt="keatmin"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/keatmin" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">keatmin</span></a></div><small class="avatar__subtitle" itemprop="description">Data nerd</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> func_tools </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> lru_cache</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:rgb(248, 248, 242)">@lru_cache</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">foo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> bar</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This is good enough if you do not need to have TTL</p><p><strong>For async version</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> async_lru </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> alru_cache</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:rgb(248, 248, 242)">@alru_cache</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">async</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">foo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> bar</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This is an exact port from the <code>lru_cache</code> version, as mentioned in <a href="https://github.com/aio-libs/async-lru" target="_blank" rel="noopener noreferrer">docs</a></p><p>If TTL is needed in async:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> aiocache </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> cached</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> Cache</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:rgb(248, 248, 242)">@cached</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ttl</span><span class="token operator">=</span><span class="token number">10</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">cache</span><span class="token operator">=</span><span class="token plain">Cache</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">MEMORY</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">async</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">foo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> bar</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Additional lib from @jianshen92:</p><p>For sync TTL cache <a href="https://github.com/lonelyenvoy/python-memoization" target="_blank" rel="noopener noreferrer">library</a></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> memoization </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> cached</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:rgb(248, 248, 242)">@cached</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ttl</span><span class="token operator">=</span><span class="token number">10</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># Cache expires after 10 seconds</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">foo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;bar&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/daily_gotchas/gotchas/tags/python">python</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/daily_gotchas/gotchas/tags/lru">lru</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/daily_gotchas/gotchas/python-venv-fyi">How Virtual Environment works</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-06-09T00:00:00.000Z" itemprop="datePublished">June 9, 2021</time> ¬∑ One min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://github.com/jianshen92" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://github.com/jianshen92.png" alt="jianshen"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/jianshen92" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">jianshen</span></a></div><small class="avatar__subtitle" itemprop="description">MLE at Shopback</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="how-does-virtualenv-works"></a>How does virtualenv works?<a class="hash-link" href="#how-does-virtualenv-works" title="Direct link to heading">#</a></h3><p>It prepends the path of python executable of virtual environment to <code>$PATH</code>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="example"></a>Example<a class="hash-link" href="#example" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">echo $PATH</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Gives</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">/Users/jianshen/.pyenv/shims:/Users/jianshen/.pyenv/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/Applications/Visual Studio Code.app/Contents/Resources/app/bin:/usr/local/opt/fzf/bin</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>After activating virtualenv, your <code>$PATH</code> variable now is:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">/Users/jianshen/Desktop/Projects/playground/venv/bin:/Users/jianshen/.pyenv/shims:/Users/jianshen/.pyenv/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/Applications/Visual Studio Code.app/Contents/Resources/app/bin:/usr/local/opt/fzf/bin</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Note that <code>/Users/jianshen/Desktop/Projects/playground/venv/bin</code> as been prepended to the <code>$PATH</code> variable. When running <code>python</code>, system will
first search through this path to look for <code>python</code> executable.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/daily_gotchas/gotchas/tags/python">python</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/daily_gotchas/gotchas/tags/venv">venv</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/daily_gotchas/gotchas/python-pytest-file-structure">Pytest File Structure</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-06-08T00:00:00.000Z" itemprop="datePublished">June 8, 2021</time> ¬∑ One min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://github.com/keatmin" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://github.com/keatmin.png" alt="keatmin"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/keatmin" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">keatmin</span></a></div><small class="avatar__subtitle" itemprop="description">Data nerd</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Given full structure:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">.</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|-- README.md</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|-- fraud_detection</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|   |-- __init__.py</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|   |-- app.py      -- from data import foo</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|   |-- conftest.py</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|   `-- data.py</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|-- requirements.txt</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">`-- tests</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    |-- __init__.py</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    |-- fraud_data.txt</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    `-- fraud_detection_test.py -- from fraud_detection.app import bar</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ul><li>Running <code>python3 fraud_detection/app.py</code> with relative import <code>from data import foo</code> will run successfully, but <code>pytest tests/</code> will fail with import error that <code>data</code> cannot be imported.</li><li>Changing relative import <code>from data import foo</code> to absolute import  <code>fraud_detection.data import foo</code> in <code>fraud_detection/app.py</code> will make pytest pass but <code>python3 fraud_detection/app.py</code> fail with import error that fraud_detection is not a module</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="reasons"></a>Reasons:<a class="hash-link" href="#reasons" title="Direct link to heading">#</a></h3><ul><li>With <code>python3 filename.py</code> at root, the path is where the file is located. Hence relative import works but pytest will fail because pytest does not know where data is located</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="solution"></a>Solution:<a class="hash-link" href="#solution" title="Direct link to heading">#</a></h3><ul><li>Use <code>python3 -m fraud_detection.app</code> and have all imports as <strong>absolute import</strong>. Same to <code>python3 -m pytest tests/</code></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="additional-thoughts"></a>Additional thoughts:<a class="hash-link" href="#additional-thoughts" title="Direct link to heading">#</a></h3><ul><li>Running <code>python3 -m pytest tests</code> is the same as running <code>pytest</code>, with the former adding current dir into PATH.</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/daily_gotchas/gotchas/tags/python">python</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/daily_gotchas/gotchas/tags/pytest">pytest</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></main></div></div></div></div>
<script src="/daily_gotchas/assets/js/runtime~main.dd476a90.js"></script>
<script src="/daily_gotchas/assets/js/main.0dc225b4.js"></script>
</body>
</html>